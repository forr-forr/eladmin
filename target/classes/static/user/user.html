<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>用户信息</title>

    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css" />
    <script src="https://unpkg.com/vue@2.6.14/dist/vue.min.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
    <script src="https://unpkg.com/vue-router@3.5.3/dist/vue-router.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <style>
        .container {
            width: 80%;
            margin: 20px auto;
        }
        #qrcode {
            text-align: center;
            margin-top: 10px;
        }

    </style>
</head>
<body>
<div id="app" class="container">
    <el-descriptions title="用户信息" :column="3" border="">
        <!-- 第一行：角色，独占 3 列 -->
        <el-descriptions-item :span="3">
            <template slot="label">
                <i class="el-icon-key"></i> 角色
            </template>
            <el-tag type="danger" v-for="role in roles" :key="role">
                {{ role }}
            </el-tag>
        </el-descriptions-item>
        <!-- 第二行：用户名、邮箱、谷歌验证密钥 -->
        <el-descriptions-item>
            <template slot="label">
                <i class="el-icon-user"></i> 用户名
            </template> {{ user.username }}
        </el-descriptions-item>
        <el-descriptions-item>
            <template slot="label">
                <i class="el-icon-message"></i> 邮箱
            </template> {{ user.email }}
        </el-descriptions-item>
        <el-descriptions-item>
            <template slot="label">
                <i class="el-icon-lock"></i> Google 验证密钥
            </template>
            <el-tag type="success" v-if="user.googleSecretKey">
                已绑定
            </el-tag>
            <el-button v-else="" type="primary" size="mini" @click="getGoogleBindingToken">
                绑定谷歌验证器
            </el-button>
        </el-descriptions-item>
        <!-- 第三行：创建时间、最后登录时间 -->
        <el-descriptions-item>
            <template slot="label">
                <i class="el-icon-date"></i> 创建时间
            </template> {{ user.createdAt }}
        </el-descriptions-item>
        <el-descriptions-item>
            <template slot="label">
                <i class="el-icon-time"></i> 上次登录
            </template> {{ user.lastLoginAt }}
        </el-descriptions-item>

        <el-descriptions-item>
            <template slot="label">
                <i class="el-icon-place"></i> 注册IP
            </template> {{ user.registrationIp }}
        </el-descriptions-item>

        <!-- 第四行：最后登录IP -->
        <el-descriptions-item>
            <template slot="label">
                <i class="el-icon-place"></i> 最后登录IP
            </template> {{ user.lastLoginIp }}
        </el-descriptions-item>

    </el-descriptions>
    <!-- 绑定谷歌验证器弹窗 -->
    <el-dialog title="绑定谷歌验证器" :visible.sync="showDialog" width="30%">
        <p>请使用 Google Authenticator 扫描以下二维码或手动输入密钥。</p>
        <div id="qrcode"></div>
        <p></p>
        <p></p>
        <el-input v-model="inputGoogleCode" placeholder="输入谷歌验证码"></el-input>
        <span slot="footer" class="dialog-footer">
     <el-button @click="showDialog = false">
      取消
     </el-button>
     <el-button type="primary" @click="bindGoogleAuth">
      绑定
     </el-button> </span>
    </el-dialog>
</div>
<script>
    new Vue({
        el: '#app',
        data() {
            return {
                loading: true,
                user: {},
                roles: [],
                showDialog: false,
                newGoogleKey: '',
                qrCodeText: '',
                inputGoogleCode: ''
            };
        },
        mounted() {
            this.fetchUserInfo();
        },
        methods: {
            fetchUserInfo() {
                axios.get('/user/getinfo')
                    .then(response => {
                        if (response.data.code === 200) {
                            const data = response.data.data;
                            this.user = data.user || {};
                            this.roles = data.roles || [];
                        } else {
                            this.$message.error("获取用户信息失败");
                        }
                    })
                    .catch(error => {
                        console.error("API请求错误:", error);
                        this.$message.error("无法连接服务器");
                    })
                    .finally(() => {
                        this.loading = false;
                    });
            },
            getGoogleBindingToken() {
                axios.get('/user/getBindingToken')
                    .then(response => {
                        if (response.data.code === 200) {
                            const data = response.data.data;
                            this.newGoogleKey = data.secretKey;
                            this.qrCodeText = data.qrCodeText;
                            this.showDialog = true;
                            this.$nextTick(() => {
                                this.generateQrCode();
                            });
                        } else {
                            this.$message.error(response.data.msg || "获取绑定信息失败");
                        }
                    })
                    .catch(error => {
                        console.error("API请求错误:", error);
                        this.$message.error("无法连接服务器");
                    });
            },
            generateQrCode() {
                if (this.qrCodeText) {
                    let qrContainer = document.getElementById("qrcode");
                    qrContainer.innerHTML = ""; // 先清空旧二维码
                    new QRCode(qrContainer, {
                        text: this.qrCodeText,
                        width: 200,
                        height: 200
                    });
                }
            },
            bindGoogleAuth() {
                if (!this.newGoogleKey || !this.inputGoogleCode) {
                    this.$message.warning("请输入谷歌验证码");
                    return;
                }

                // 使用正则表达式确保输入的是 6 位数字
                if (!/^\d{6}$/.test(this.inputGoogleCode)) {
                    this.$message.error("验证码必须是 6 位数字");
                    return;
                }

                const codeInt = Number(this.inputGoogleCode); // 确保转换为 number 类型

                console.log("提交的参数:", {
                    secretKey: this.newGoogleKey,
                    code: codeInt
                });

                axios.post('/user/verifyAndBindToken', {
                    secretKey: this.newGoogleKey,
                    code: codeInt  // 传递 int 类型
                }).then(response => {
                    console.log("API 响应:", response.data);
                    if (response.data.code === 200) {
                        this.$message.success("绑定成功");
                        this.user.googleSecretKey = this.newGoogleKey;
                        this.showDialog = false;
                        this.fetchUserInfo();
                        // 刷新整个页面
                        parent.location.reload();

                    } else {
                        this.$message.error(response.data.msg );
                    }
                }).catch(error => {
                    console.error("API请求错误:", error);
                    this.$message.error("无法连接服务器");
                });
            }

        }
    });
</script>
</body>
</html>