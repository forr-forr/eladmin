<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>操作日志管理</title>
    <link rel="stylesheet" href="../element-ui/lib/theme-chalk/index.css">
    <script src="../js/vue.js"></script>
    <script src="../element-ui/lib/index.js"></script>
    <script src="../js/axios-0.18.0.js"></script>
</head>
<body>
<style>
    .demo-table-expand {
        font-size: 0;
    }
    .demo-table-expand label {
        width: 90px;
        color: #99a9bf;
    }
    .demo-table-expand .el-form-item {
        margin-right: 0;
        margin-bottom: 0;
        width: 50%;
    }
</style>
<div id="app" v-if="hasPermission('log:query')">
    <el-form inline>
        <el-form-item label="用户ID">
            <el-input v-model="searchForm.userId" placeholder="请输入用户ID" clearable></el-input>
        </el-form-item>
        <el-form-item label="用户名">
            <el-input v-model="searchForm.username" placeholder="请输入用户名" clearable></el-input>
        </el-form-item>
        <el-form-item label="操作类型">
            <el-select v-model="searchForm.category" placeholder="请选择操作类型" clearable>
                <el-option label="用户操作" value="user"></el-option>
                <el-option label="钱包操作" value="wallet"></el-option>
                <el-option label="其他" value="other"></el-option>
            </el-select>
        </el-form-item>
        <el-form-item>
            <el-button type="primary" icon="el-icon-search" @click="searchLogs">查询</el-button>
            <el-button icon="el-icon-refresh" @click="resetSearch">重置</el-button>
        </el-form-item>
    </el-form>

    <el-table
            :data="logTableData"
            v-loading="logLoading"
            border
            style="width: 100%">
        <el-table-column type="expand">
            <template slot-scope="props">
                <el-form label-position="left" inline class="demo-table-expand">
                    <el-form-item label="操作类型:">
                        <span>{{ props.row.category }}</span>
                    </el-form-item>
                    <el-form-item label="请求方式:">
                        <span>{{ props.row.requestMethod }}</span>
                    </el-form-item>
                    <el-form-item label="客户端信息:">
                        <span>{{ props.row.clientInfo }}</span>
                    </el-form-item>
                    <el-form-item label="创建时间:">
                        <span>{{ formatDate(props.row.createTime) }}</span>
                    </el-form-item>
                    <el-form-item label="请求参数:">
                        <span>{{ props.row.operationParams }}</span>
                    </el-form-item>
                    <el-form-item label="结果信息:">
                        <span>{{ props.row.resultMessage }}</span>
                    </el-form-item>
                </el-form>
            </template>
        </el-table-column>
        <el-table-column prop="id" label="日志ID" width="100" align="center"></el-table-column>
        <el-table-column prop="userId" label="用户ID" width="100" align="center"></el-table-column>
        <el-table-column prop="username" label="用户名" width="100" align="center"></el-table-column>
        <el-table-column prop="methodName" label="方法名" width="170" align="center"></el-table-column>
        <el-table-column prop="operationDesc" label="操作描述" min-width="200" align="center"></el-table-column>
        <el-table-column prop="requestPath" label="请求路径" min-width="150" align="center"></el-table-column>
        <el-table-column prop="ipAddress" label="IP" width="150" align="center"></el-table-column>
        <el-table-column prop="statusCode" label="状态" width="100" align="center">
            <template slot-scope="scope">
                <el-tag :type="scope.row.statusCode === 200 ? 'success' : 'danger'">
                    {{ scope.row.statusCode }}
                </el-tag>
            </template>
        </el-table-column>
        <el-table-column prop="executionTimeMs" label="耗时(ms)" width="100" align="center"></el-table-column>
        <el-table-column prop="requestTime" label="请求时间" width="180" align="center">
            <template slot-scope="scope">
                {{ formatDate(scope.row.createTime) }}
            </template>
        </el-table-column>
    </el-table>

    <el-pagination
            @size-change="handleSizeChange"
            @current-change="handleCurrentChange"
            :current-page="pagination.currentPage"
            :page-sizes="[10, 20, 50, 100]"
            :page-size="pagination.pageSize"
            layout="total, sizes, prev, pager, next, jumper"
            :total="pagination.total"
            style="margin-top: 20px; text-align: center;">
    </el-pagination>
</div>

<script>
    new Vue({
        el: '#app',
        data: {
            logTableData: [],
            logLoading: false,
            userPermissions: [],
            searchForm: {
                userId: '',
                username: '',
                category: ''
            },
            pagination: {
                currentPage: 1,
                pageSize: 10,
                total: 0
            }
        },
        beforeMount() {
            const storedPermissions = JSON.parse(localStorage.getItem("userPermissions") || "[]");
            this.userPermissions = storedPermissions;

            if (!this.hasPermission('log:query')) {
                alert('你没有权限访问这个页面');
                parent.location.reload();
                return;
            }

            this.fetchLogs();
        },
        methods: {
            hasPermission(permission) {
                if (Array.isArray(permission)) {
                    return this.userPermissions.some(perm => permission.includes(perm));
                }
                return this.userPermissions.includes(permission);
            },
            formatDate(date) {
                if (!date) return "暂无数据";
                return new Date(date).toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' });
            },
            fetchLogs() {
                this.logLoading = true;
                const params = {
                    page: this.pagination.currentPage,
                    size: this.pagination.pageSize,
                    userId: this.searchForm.userId,
                    username: this.searchForm.username,
                    category: this.searchForm.category
                };

                axios.get('/operation-logs/list', { params })
                    .then(response => {
                        if (response.data && response.data.code === 200) {
                            this.logTableData = response.data.data.data || [];
                            this.pagination.total = response.data.data.total || 0;
                            this.$message({
                                message: '日志数据获取成功[' + this.logTableData.length + "]",
                                type: 'success'
                            });
                        } else {
                            this.$message.error(response.data.msg || '数据格式错误！');
                        }
                    })
                    .catch(error => {
                        this.$message.error('查询日志失败！' + (error.response?.data?.msg || error.message));
                    })
                    .finally(() => {
                        this.logLoading = false;
                    });
            },
            searchLogs() {
                this.pagination.currentPage = 1;
                this.fetchLogs();
            },
            resetSearch() {
                this.searchForm.userId = '';
                this.searchForm.username = '';
                this.searchForm.category = '';
                this.pagination.currentPage = 1;
                this.fetchLogs();
            },
            handleSizeChange(val) {
                this.pagination.pageSize = val;
                this.fetchLogs();
            },
            handleCurrentChange(val) {
                this.pagination.currentPage = val;
                this.fetchLogs();
            }
        }
    });
</script>

</body>
</html>