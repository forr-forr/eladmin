<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>后台管理系统</title>
    <link rel="stylesheet" href="element-ui/lib/theme-chalk/index.css">
    <script src="js/vue.js"></script>
    <script src="element-ui/lib/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        .el-header {
            background-color: #545c64;
        }

        /* 1. 确保 HTML 和 Body 撑满整个视口 */
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* 防止出现多余的滚动条 */
        }

        /* 2. 确保 #app 容器撑满整个视口 */
        #app {
            height: 100%;
        }

        /* 3. 为最外层的 el-container 设置 Flexbox 布局 */
        .el-container.main-layout {
            height: 100%;
            display: flex;
            flex-direction: column; /* 垂直排列头部和主体内容 */
        }

        /* 4. 让包含侧边栏和主内容的容器填满剩余空间 */
        .el-container.body-content {
            flex: 1; /* 占据除了 el-header 之外的所有空间 */
            border: 1px solid #eee;
        }

        /* 5. el-main 填满父容器的剩余空间 */
        .el-main {
            padding: 0; /* 移除默认内边距 */
            flex: 1; /* 占据除了 el-aside 之外的所有空间 */
            display: flex;
            flex-direction: column;
        }

        /* 6. el-tabs 填满 el-main 的剩余空间 */
        .el-tabs {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* 7. el-tabs 的内容区填满剩余空间 */
        .el-tabs__content {
            flex: 1;
            overflow-y: hidden; /* 隐藏 tabs 内容区的滚动条，让 iframe 自己滚动 */
            display: flex;
            flex-direction: column;
        }

        /* 8. 确保 el-tab-pane 填满其父容器 */
        .el-tab-pane {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* 9. 确保 iframe 最终填满所有可用空间 */
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>
<body>
<div id="app">
    <el-container v-if="!fullscreenLoading" class="main-layout">
        <el-header class="el-header">
            <el-container>
                <el-menu
                        mode="horizontal"
                        background-color="#545c64"
                        text-color="white"
                        active-text-color="#ffd04b"
                        style="margin-left: auto;">
                    <el-submenu index="2">
                        <template slot="title">
                            <span>{{ username }}的工作台</span>
                        </template>
                        <el-menu-item @click="openTab('个人资料', '/user/user.html')">
                            <i class="el-icon-user"></i> 个人信息
                        </el-menu-item>
                        <el-menu-item index="2-3" @click="logout">
                            <i class="el-icon-switch-button"></i> 退出登录
                        </el-menu-item>
                    </el-submenu>
                </el-menu>
            </el-container>
        </el-header>
        <el-container class="body-content">
            <el-aside width="200px" style="background-color: rgb(238, 241, 246)">
                <el-menu
                        :default-openeds="openedMenus"
                        :default-active="activeTab"
                        @open="handleOpen"
                        @close="handleClose"
                >
                    <!-- 主页 -->
                    <el-menu-item
                            index="/user/userHome.html"
                            @click="openTab('主页', '/user/userHome.html')"
                    >
                        <i class="el-icon-house"></i> 主页
                    </el-menu-item>

                    <!-- 管理员操作 - 只有admin和root角色可见 -->
                    <el-submenu
                            v-if="['admin', 'root'].includes(userRole)"
                            index="admin-operations"
                    >
                        <template slot="title">
                            <i class="el-icon-setting"></i> 管理员操作
                        </template>
                        <el-menu-item
                                index="users.html"
                                @click="openTab('用户管理', 'admin/users.html')"
                        >
                            <i class="el-icon-user-solid"></i> 用户管理
                        </el-menu-item>
                        <el-menu-item
                                index="role.html"
                                @click="openTab('角色管理', 'admin/role.html')"
                        >
                            <i class="el-icon-key"></i> 角色管理
                        </el-menu-item>
                        <el-menu-item
                                index="permission.html"
                                @click="openTab('权限管理', 'admin/permission.html')"
                        >
                            <i class="el-icon-lock"></i> 权限管理
                        </el-menu-item>
                        <el-menu-item
                                index="userlog.html"
                                @click="openTab('操作日志', 'admin/userlog.html')"
                        >
                            <i class="el-icon-notebook-2"></i> 操作日志
                        </el-menu-item>
                    </el-submenu>

                    <!-- 个人资料 -->
                    <el-menu-item
                            index="/user/user.html"
                            @click="openTab('个人资料', '/user/user.html')"
                    >
                        <i class="el-icon-user"></i> 个人资料
                    </el-menu-item>
                </el-menu>
            </el-aside>
            <el-container class="main-content">
                <el-main>
                    <el-tabs v-model="activeTab" type="card" closable @tab-remove="removeTab">
                        <el-tab-pane
                                v-for="tab in tabs"
                                :key="tab.name"
                                :label="tab.title"
                                :name="tab.name">
                            <iframe :src="tab.url" frameborder="0"></iframe>
                        </el-tab-pane>
                    </el-tabs>
                </el-main>
            </el-container>
        </el-container>
    </el-container>
</div>

<script>
    new Vue({
        el: "#app",
        data() {
            return {
                fullscreenLoading: true,
                username: '',
                userRole: '',
                activeTab: "/user/userHome.html",
                tabs: [
                    { title: "主页", name: "/user/userHome.html", url: "/user/userHome.html" }
                ],
                openedMenus: ['admin-operations'],
                userPermissions: [],
                userRoles: []
            };
        },
        methods: {
            hasRole(role) {
                if (!this.userRoles) return false;
                if (Array.isArray(role)) {
                    return this.userRoles.some(r => role.includes(r));
                }
                return this.userRoles.includes(role);
            },
            openTab(title, url) {
                console.log("Clicked Tab:", title, url);
                this.activeTab = url;
                let exist = this.tabs.find(tab => tab.name === url);
                if (!exist) {
                    this.tabs.push({ title, name: url, url });
                }
                // 自动展开管理员操作菜单
                if (url.startsWith('admin/') && !this.openedMenus.includes('admin-operations')) {
                    this.openedMenus.push('admin-operations');
                }
            },
            removeTab(targetName) {
                let index = this.tabs.findIndex(tab => tab.name === targetName);
                this.tabs.splice(index, 1);
                if (this.activeTab === targetName) {
                    this.activeTab = this.tabs.length ? this.tabs[this.tabs.length - 1].name : "";
                }
            },
            handleOpen(key, keyPath) {
                if (!this.openedMenus.includes(key)) {
                    this.openedMenus.push(key);
                }
            },
            handleClose(key, keyPath) {
                this.openedMenus = this.openedMenus.filter(item => item !== key);
            },
            checkLogin() {
                axios.get('/user/getinfo')
                    .then(response => {
                        if (!response.data.data || !response.data.data.user) {
                            this.$message.error(response.data.msg);
                            window.location.href = "/login.html";
                        } else {
                            this.username = response.data.data.user.username;
                            this.userRoles = response.data.data.roles;
                            this.userPermissions = response.data.data.permissions;
                            localStorage.setItem("userRoles", JSON.stringify(this.userRoles));
                            localStorage.setItem("userPermissions", JSON.stringify(this.userPermissions));
                            localStorage.setItem("user", JSON.stringify(response.data.data.user));

                            // 判断用户角色
                            this.userRole = this.userRoles.includes('root') ? 'root' :
                                (this.userRoles.includes('admin') ? 'admin' : 'user');

                            this.$message.success("登录成功！");
                        }
                    })
                    .catch(error => {
                        if (error.response && error.response.data) {
                            this.$message.error(error.response.data.msg);
                        } else {
                            this.$message.error("请求失败，请稍后再试！");
                        }
                        setTimeout(() => {
                            window.location.href = "/login.html";
                        }, 2000);
                    })
                    .finally(() => {
                        this.fullscreenLoading = false;
                    });
            },
            logout() {
                axios.get('/user/logout')
                    .then(response => {
                        this.$message.success("退出成功");
                        setTimeout(() => {
                            window.location.href = "/login.html";
                        }, 1000);
                    })
                    .catch(error => {
                        window.location.href = "/login.html";
                    });
            }
        },
        mounted() {
            this.checkLogin();
        }
    });
</script>
</body>
</html>